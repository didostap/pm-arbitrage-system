# Epic 3 Retrospective - Arbitrage Detection & Contract Matching

**Date:** 2026-02-17
**Epic:** Epic 3 (Sprint 0 + Stories 3.1 - 3.4)
**Facilitator:** Bob (Scrum Master)
**Participant:** Arbi (Project Lead)

## Epic Summary

**Delivery Metrics:**
- **Completed:** 5/5 items (Sprint 0 + 4 stories) — 100%
- **Test Progression:** 249 → 314 → 330 → 349 → 367 → 381 tests
- **New Tests Added:** 132 across Epic 3
- **Code Review Fixes:** 14 total (3 high, 7 medium, 4 low severity)
- **Technical Debt Items:** 3 carry-forward (technical-debt.md, dry-run validation, property-based testing)
- **Production Incidents:** 0
- **Import Boundary Violations:** 0

**Stories Delivered:**
1. Sprint 0: Financial math foundations, decimal.js, config schema, migration rollbacks ✅
2. Story 3.1: Manual Contract Pair Configuration (YAML loader, ConfigValidationError) ✅
3. Story 3.2: Cross-Platform Arbitrage Detection (DetectionService, bidirectional gross edge) ✅
4. Story 3.3: Edge Calculation & Opportunity Filtering (EdgeCalculatorService, events) ✅
5. Story 3.4: Contract Match Approval Workflow MVP (Prisma migration, upsert sync) ✅

**Business Outcomes:**
- ✅ Manual contract pair configuration operational (YAML-based, validated at startup)
- ✅ Cross-platform arbitrage detection live (bidirectional gross edge calculation)
- ✅ Edge calculation with fee/gas accounting (FinancialMath decimal precision)
- ✅ Opportunity filtering at 0.8% threshold with degradation multiplier (1.5x)
- ✅ Contract match tracking in database (idempotent upsert sync)
- ✅ Domain events emitting (OpportunityIdentifiedEvent, OpportunityFilteredEvent)
- ✅ Detection pipeline wired into TradingEngineService.executeCycle() (Steps 2 + 2b)

## Previous Retrospective Follow-Through (Epic 2)

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Document decision rationale in story files | ✅ Done | PRD formula error documented in Sprint 0, plainToInstance gotcha in 3.1, connector injection rationale in 3.2, common/ boundary pattern in 3.3 |
| 2 | Maintain technical debt register | ⏳ Partial | Debt tracked in story dev notes but no centralized technical-debt.md created |
| 3 | Tailor retro for solo project | ✅ Applied | No team-based commitments in Epic 3 |
| 4 | Explicit Sprint 0 gate definition | ✅ Done | AC6 regression gate (314 tests), clear scope guards in all stories |
| 5 | Execute Epic 3 Sprint 0 (9 hours) | ✅ Done | All 3 tasks delivered: 16 CSV scenarios, FinancialMath utility, config schema, rollbacks |
| 6 | Dry-run validation (48h live markets) | ❌ Not done | Blocked: no read-only market data pipeline exists. Requires safe WebSocket consumer setup. |
| 7 | Enhanced Story 3.3 test coverage | ⏳ Partial | 18 edge calculator tests including CSV scenarios. Property-based/fuzz testing not implemented. |

**Summary:** 4/7 completed or applied, 2 partial, 1 not addressed (blocked by infrastructure).

## What Went Well

### 1. Sprint 0 Investment — Compounding Returns
- 16 hand-verified CSV scenarios reused across Stories 3.2, 3.3
- FinancialMath utility with FinancialDecimal clone used by DetectionService and EdgeCalculatorService
- PRD formula catch (prose formula wrong, worked example correct) prevented systematic miscalculation
- Sprint 0 produced 65 new tests that formed the foundation for all subsequent stories

### 2. Code Review Rigor — Catching Real Bugs
- **H1 (Sprint 0):** Global `Decimal.set()` replaced with `Decimal.clone()` → prevents cross-module precision pollution
- **H1 (Story 3.1):** Null/non-object check for empty YAML file content
- **H1 (Story 3.3):** `mockResolvedValue` → `mockReturnValue` for synchronous `processDislocations()` — silent test failure
- **H2 (Story 3.3):** Missing `OnModuleInit` startup config validation for negative/NaN values
- **M1 (Story 3.3):** Added `skippedErrors` counter to EdgeCalculationResult summary

### 3. Architectural Boundary Discipline
- `common/` → `modules/` boundary respected: event classes use `Record<string, unknown>` payload
- Concrete connector injection pattern (not interface tokens) — consistent with DataIngestionService
- FinancialDecimal clone pattern isolates precision config from global Decimal
- Module dependency rules followed: arbitrage-detection → contract-matching (allowed), no reverse imports

### 4. Testing Discipline
- 249 → 381 tests (132 new, zero regressions)
- Every story maintained regression gate against prior baseline
- Co-located spec files following established pattern
- Real FinancialMath integration in tests (not mocked)

### 5. Decision Documentation
- Every story file has rich dev notes explaining WHY, not just WHAT
- Scope guards ("What NOT to Do") prevented scope creep
- Previous story intelligence sections enabled smooth handoffs between stories

## Challenges & Learnings

### 1. Unfulfilled Retro Commitments
- **Challenge:** 3 of 7 Epic 2 retro items incomplete (technical-debt.md, dry-run, property-based testing)
- **Root Cause:** Commitments lacked concrete deliverables (dry-run blocked by infrastructure, property-based testing vaguely scoped)
- **Learning:** Make commitments specific and gated — "test the composition chain for NaN propagation" not "add property-based testing"
- **Action:** Property-based testing now has precise scope (composition chain testing, not just individual functions)

### 2. Framework Gotchas Cost Time
- **plainToInstance() defaults:** TypeScript property defaults not applied by class-transformer without `exposeDefaultValues: true`. Loader must explicitly default fields during DTO → Config transform.
- **OnModuleInit ordering:** NestJS doesn't guarantee execution order between providers in same module. ContractMatchSyncService needed defensive check for loaded pairs.
- **Learning:** Document these in gotchas.md to prevent repeat time burns

### 3. Detection Pipeline Unvalidated Against Real Data
- **Challenge:** 381 tests but zero real market data flowing through the pipeline
- **Impact:** Building risk management (Epic 4) on detection accuracy we haven't empirically validated
- **Mitigation:** Read-only market data pipeline as parallel track during Epic 4, reviewed before Epic 5
- **Learning:** Distinguish between "tested" (unit/integration) and "validated" (real-world data)

### 4. PRD Prose vs Example Discrepancy
- **Challenge:** PRD fee formula prose says flat subtraction, worked example shows percentage-based application
- **Impact:** Would have caused systematic edge miscalculation across entire system
- **Resolution:** Caught in Sprint 0, documented extensively, FinancialMath implements correct formula
- **Learning:** When spec is ambiguous, follow the concrete example over the abstract description

## Key Insights

1. **Sprint 0 prep has compounding returns** — investment in test scenarios and utility foundations paid dividends across 3 stories
2. **Code reviews catch production bugs, not just style** — 3 high-severity fixes prevented runtime failures
3. **Retro commitments need execution discipline** — vague commitments don't get done; specific, gated ones do
4. **Architectural boundary patterns are velocity patterns** — decisions made once (event payload typing, connector injection, FinancialDecimal) reused indefinitely
5. **Composition chain testing > individual function testing** — NaN propagation through edge → risk → sizing is the real failure mode

## Technical Debt Inventory

### Carry-Forward from Epic 2
1. **Dynamic Gas Estimation** (Priority: Medium, Target: Epic 5)
   - Current: Static conservative estimate ($0.30 default)
   - Future: Dynamic via viem for Polymarket on-chain transactions

2. **IPlatformConnector Async Confirmation Methods** (Priority: Medium, Target: Epic 5)
   - Current: Off-chain CLOB orders (synchronous)
   - Future: `confirmTransaction()`, `getTransactionStatus()` for on-chain settlement

3. **Encrypted Keystore for Polymarket Wallet** (Priority: Low, Target: Epic 11)
   - Current: Direct private key in environment variables
   - Future: Encrypted keystore with passphrase

### New from Epic 3
4. **Centralized Technical Debt Register** (Priority: Medium, Target: Epic 4 prep)
   - `technical-debt.md` committed to twice, not yet created

5. **Property-Based / Fuzz Testing for FinancialMath** (Priority: High, Target: Epic 4 prep — hard gate)
   - Composition chain testing: edge → risk sizing → budget allocation
   - fast-check library with realistic arbitraries

6. **Dry-Run Validation Against Live Markets** (Priority: High, Target: parallel during Epic 4)
   - Read-only market data pipeline needed first
   - 48-hour detection run, manually verify 20-30 opportunities
   - Must complete before Epic 5

## Epic 4 Preparation Plan

### Readiness Assessment
**Status:** Ready with targeted preparation

**Codebase Health:** Stable and maintainable (Arbi's assessment). 381 tests, lint clean, zero architectural violations.

### Critical Preparation (before Epic 4 starts)

1. **Property-based / fuzz testing for FinancialMath** — HARD GATE
   - Owner: Arbi
   - Scope: fast-check arbitraries for price (0-1), fee (0-5%), gas (0-1), position size (10-10000)
   - Key: Test composition chain (calculateGrossEdge → calculateNetEdge → position sizing), not just individual functions
   - Assert: every chain invocation returns finite Decimal, no NaN propagation
   - Target: 1000+ random inputs

2. **Concurrency architecture decision: in-process mutex**
   - Owner: Arbi
   - Decision: MVP uses in-process async mutex (not Redis distributed lock)
   - Rationale: Single NestJS instance, single operator. Redis locks are Epic 11 scope.
   - Document in Story 4.4 dev notes

3. **Pipeline latency instrumentation**
   - Owner: Arbi
   - Add timing to existing detection pipeline stages
   - Establish baseline before inserting risk validation step
   - Simple Date.now() deltas at detection, edge calculation stages

### Parallel Track (during Epic 4)

4. **Read-only market data dry-run pipeline**
   - Owner: Arbi
   - Safe WebSocket consumer logging order book snapshots
   - Run detection pipeline against live data, manually verify 20-30 opportunities
   - Does NOT block Epic 4 start
   - Results must be reviewed before Epic 5

### Documentation

5. **Create `technical-debt.md`** — consolidate from Epic 2-3 story notes
6. **Create `docs/gotchas.md`** — plainToInstance defaults, OnModuleInit ordering, Record<string, unknown> boundary pattern
7. **Retro commitment tracking** — check previous retro action items at each story kickoff, not just at epic retro

### Epic 4 Dependencies on Epic 3
- `EnrichedOpportunity` type → consumed by `IRiskManager.validatePosition()`
- `FinancialDecimal` precision → used for position sizing calculations
- `OpportunityIdentifiedEvent` → risk validation hooks into event pipeline
- Detection → Risk → Execution synchronous hot path (CLAUDE.md constraint)
- `contract_matches` table → risk_states table added alongside

### Critical Epic 4 Risk: Hot Path Performance
- Risk validation inserts into the synchronous Detection → Execution chain
- `validatePosition()` must be fast — no blocking DB queries in hot path
- Pipeline instrumentation (prep item #3) provides baseline to measure impact

## Action Items Summary

| # | Action Item | Owner | Deadline | Type |
|---|---|---|---|---|
| 1 | Create technical-debt.md register | Arbi | Before Story 4.1 | Process |
| 2 | Create docs/gotchas.md | Arbi | Before Story 4.1 | Documentation |
| 3 | Property-based testing for FinancialMath (composition chain) | Arbi | Before Story 4.1 (HARD GATE) | Technical |
| 4 | Concurrency decision: in-process mutex for MVP | Arbi | Before Story 4.4 creation | Architecture |
| 5 | Pipeline latency instrumentation | Arbi | Before Story 4.1 | Technical |
| 6 | Read-only market data dry-run pipeline | Arbi | Parallel during Epic 4 | Validation |
| 7 | Retro commitment tracking at story kickoff | Bob | Ongoing from Epic 4 | Process |

## Retrospective Commitments

### What We Learned
- Sprint 0 prep compounds — invest in test scenarios and shared utilities early
- Code reviews are a quality gate, not ceremony — 3 high-severity catches this epic
- Retro commitments need concrete scope and gating — vague ones don't execute
- Architectural decisions are velocity decisions — solve boundary patterns once, reuse forever
- Composition chain testing is more valuable than individual function testing for financial math

### What We'll Do Differently
- **Gate property-based testing** on Story 4.1 start (not optional carry-forward)
- **Check retro commitments at story kickoff** (not just at next retro)
- **Run dry-run validation as parallel track** (not as a blocking gate that never happens)
- **Document framework gotchas centrally** (not buried in individual story dev notes)
- **Make commitments specific** ("test composition chain for NaN propagation" not "add property-based testing")

### What We'll Keep Doing
- Sprint 0 targeted preparation for complex epics
- Code review on every story with severity-graded fixes
- Rich dev notes with decision rationale and scope guards
- Architecture compliance (module boundaries, error hierarchy, event patterns)
- Regression gate at every story (test count baseline tracking)
- Previous story intelligence sections for smooth handoffs

## Team Acknowledgment

Epic 3 delivered a complete arbitrage detection pipeline:
- YAML config → validated contract pairs → bidirectional detection → edge calculation with fees/gas → opportunity filtering at 0.8% threshold → domain events → database tracking
- 132 new tests (249 → 381) with zero regressions
- 14 code review fixes including 3 high-severity bug catches
- Zero architectural violations across 5 stories
- Strong decision documentation throughout

**Performance:** Excellent. 100% delivery, quality maintained, detection pipeline operational, ready for Epic 4.

---

**Retrospective Status:** ✅ Complete
**Epic 3 Status:** ✅ Delivered
**Epic 4 Readiness:** Ready with targeted preparation (3 critical prep items)
**Next Milestone:** Property-based testing + technical-debt.md + gotchas.md → then Story 4.1
