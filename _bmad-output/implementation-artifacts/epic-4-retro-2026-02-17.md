# Epic 4 Retrospective - Risk Management & Position Controls

**Date:** 2026-02-17
**Epic:** Epic 4 (Stories 4.1 - 4.4)
**Facilitator:** Bob (Scrum Master)
**Participant:** Arbi (Project Lead)

## Epic Summary

**Delivery Metrics:**
- **Completed:** 4/4 stories — 100%
- **Test Progression:** 381 → 397 → 423 → 447 → 484 tests
- **New Tests Added:** 103 across Epic 4
- **Code Review Fixes:** 11 total (2 high, 5 medium, 4 low severity)
- **Technical Debt Items:** 0 new structural debt introduced
- **Production Incidents:** 0
- **Import Boundary Violations:** 0

**Stories Delivered:**
1. Story 4.1: Position Sizing & Portfolio Limits — IRiskManager, RiskLimitError hierarchy, risk_states table, 3% bankroll cap, 10 open pairs limit, FinancialDecimal precision, trading engine STEP 3 integration
2. Story 4.2: Daily Loss Limit & Trading Halt — 5% daily loss halt, midnight UTC reset, fire-once approach warnings, stale-day detection, persistence failure resilience, corrupted state handling
3. Story 4.3: Operator Risk Override — first REST endpoint, AuthTokenGuard, DTO validation, override audit trail (risk_override_logs table), daily loss halt cannot be overridden
4. Story 4.4: Sequential Execution Locking & Risk Budget Reservation — ExecutionLockService, ExecutionQueueService, atomic budget reservation lifecycle (reserve/commit/release), startup crash recovery

**Business Outcomes:**
- Capital protection live: 3% position cap + 10 simultaneous pair limit enforced
- Catastrophic loss prevention: automatic trading halt at 5% daily loss
- Operator override pathway with audit trail and daily-loss-halt guard
- Concurrent opportunity race condition eliminated (sequential lock + atomic reservation)
- Crash recovery for stale reservations on startup
- First authenticated REST API endpoint operational

## Previous Retrospective Follow-Through (Epic 3)

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Create technical-debt.md register | ❌ Not done | No technical-debt.md file found |
| 2 | Create docs/gotchas.md | ❌ Not done | No gotchas.md file found |
| 3 | Property-based testing for FinancialMath (HARD GATE) | ❌ Not done | No fast-check or property-based tests in any Epic 4 story |
| 4 | Concurrency decision: in-process mutex for MVP | ✅ Done | Story 4.4 used promise-based global lock as decided |
| 5 | Pipeline latency instrumentation | ❌ Not done | No timing instrumentation added to pipeline |
| 6 | Read-only market data dry-run pipeline | ❌ Not done | Still no real market data flowing through detection |
| 7 | Retro commitment tracking at story kickoff | ❌ Not done | No evidence of retro check-ins in story dev notes |

**Summary:** 1/7 completed. Root cause identified: commitments outside the story system don't get executed. The one item completed (concurrency decision) was embedded directly in Story 4.4's implementation — couldn't avoid it.

**Key Learning:** Three consecutive epics have proven that retro action items floating outside the story system are not executed. If it's not in a story's acceptance criteria, it won't happen. This pattern is now addressed by Epic 4.5.

## What Went Well

### 1. Story-to-Story Handoff Quality
- Every story had a "Previous Story Intelligence" section with exact test baselines, patterns to follow, and known gotchas
- Story 4.2 knew `ConfigService.get` returns strings because Story 4.1 documented it
- Previous story intelligence enabled smooth builds with minimal re-discovery

### 2. Scope Guard Discipline
- Every story had a "What NOT to Do" section preventing scope creep
- No story attempted to implement Telegram alerts, dashboard UI, or correlation tracking
- Each story did exactly what it was specified to do and stopped

### 3. Code Reviews Catching Production Bugs
- 11 code review fixes across 4 stories
- H1 (Story 4.4): `reserveBudget()` over-reserving by always using config max instead of `min(requested, max)` — would have over-reserved capital in production
- H1 (Story 4.3): Dead halt check in `determineRejectionReason` removed
- M1 (Story 4.2): `handleMidnightReset` set `lastResetTimestamp` to `new Date()` instead of UTC midnight — would cause stale-day detection failure
- M3 (Story 4.4): `validatePosition()` now checks available capital including reserved capital as pre-screen

### 4. First REST Endpoint Foundation (Story 4.3)
- Story 4.3 established all REST patterns: AuthTokenGuard, DTO validation with class-validator, error response wrapping, HTTP status code conventions, circular import resolution via constants extraction
- Every future endpoint (Stories 5.2, 5.3, all of Epic 7) inherits these patterns for free
- Similar to Sprint 0's investment — pay once, reuse everywhere

### 5. Execution Infrastructure (Story 4.4)
- Promise-based global lock with 30s safety timeout
- Atomic budget reservation lifecycle: reserve → commit/release
- ExecutionQueueService processing ranked opportunities sequentially
- Startup crash recovery clearing stale reservations
- `min(requested, max)` position sizing in reservations (code review fix)

## Challenges & Learnings

### 1. Retro Commitment Failure Pattern (1/7 completed)
- **Challenge:** Only 1 of 7 Epic 3 retro commitments completed
- **Root Cause:** Commitments existed outside the story system with no enforcement mechanism
- **Pattern:** Third consecutive epic with this failure mode (Epic 2 → 3 → 4)
- **Resolution:** Epic 4.5 mini-epic — all remaining items converted to stories with ACs
- **Learning:** If it's not in a story's acceptance criteria, it won't happen. Proven three times.

### 2. Error Code Drift from PRD
- **Challenge:** PRD error catalog lists `3001 = Daily Loss Limit Exceeded` but codebase has `3001 = Position Size Exceeded`, `3003 = Daily Loss Limit Breached`
- **Root Cause:** PRD error catalog written top-down; actual codes assigned bottom-up as stories needed them
- **Impact:** PRD error catalog is now inaccurate. Not a runtime issue but a documentation lie.
- **Resolution:** Deferred to post-Epic 5 reconciliation. Codebase is source of truth.

### 3. e2e Test Environment Variable Accumulation
- **Challenge:** Every story required adding env vars to 3 separate e2e test files manually
- **Impact:** Estimated 1+ hour accumulated cost across Epic 4, plus mental friction per story
- **Root Cause:** Classic "not worth fixing right now" debt that compounds
- **Resolution:** Story 4.5.3 — extract shared test environment config

### 4. The `unknown` Type Boundary Pattern
- **Challenge:** `IRiskManager` uses `unknown` parameter types to avoid importing from `modules/` into `common/interfaces/`
- **Assessment:** Accepted trade-off. The architectural boundary is more valuable than type safety at one cast point. Cast happens once at method entry; everything is fully typed after that.
- **Resolution:** No action needed. This is by design.

### 5. First-Endpoint Growing Pains (Story 4.3)
- **Challenge:** Story 4.3 was the first REST controller — had to establish auth, validation, error wrapping, and resolve circular import patterns all at once
- **Impact:** Most expensive story relative to functional complexity
- **Assessment:** Worthwhile foundational investment. All future endpoints inherit for free.

## Key Insights

1. **Retro commitments outside the story system don't execute** — proven across 3 epics. Embed prep work as stories with ACs.
2. **First-of-a-kind stories pay foundational tax** — Story 4.3 established REST patterns that all future endpoints inherit.
3. **Code reviews are a production bug catcher** — 2 high-severity catches prevented real-money bugs.
4. **Story-to-story handoff quality is a velocity multiplier** — Previous Story Intelligence sections prevent repeated debugging.
5. **"Ready to build" and "ready to run" are different** — Epic 5 construction can proceed, but live execution requires validation first.

## Technical Debt Inventory

### Carry-Forward from Epics 2-3
1. **Dynamic Gas Estimation** (Priority: Medium, Target: Epic 5) — static $0.30 default
2. **IPlatformConnector Async Confirmation Methods** (Priority: Medium, Target: Epic 5)
3. **Encrypted Keystore for Polymarket Wallet** (Priority: Low, Target: Epic 11)

### Addressed by Epic 4.5
4. **Property-Based Testing for FinancialMath** → Story 4.5.1
5. **Pipeline Latency Instrumentation** → Story 4.5.2
6. **Shared e2e Test Environment Config** → Story 4.5.3
7. **Centralized technical-debt.md and gotchas.md** → Story 4.5.4

### Deferred to Post-Epic 5
8. **PRD Error Code Catalog Reconciliation** — reconcile after 2000-2999 codes assigned
9. **Live Market Dry-Run Validation** — 48h read-only detection gate before production deployment

## Epic 4.5 — Pre-Execution Validation Sprint (HARD GATE before Epic 5)

### Rationale
Three consecutive epics have proven that retro action items outside the story system don't get executed. Epic 4.5 converts all outstanding validation and hygiene commitments into real stories with acceptance criteria. Epic 5 does not start until Epic 4.5 clears.

### Stories

**Story 4.5.0: Regression Baseline Verification**
- Verify current 484 tests pass clean on fresh checkout before adding anything
- AC: `pnpm test` passes with 484+ tests, zero failures, `pnpm lint` clean
- Gates: All other 4.5 stories

**Story 4.5.1: Property-Based Testing for FinancialMath Composition Chain**
- Install fast-check, write arbitraries for price (0-1), fees (0-5%), gas (0-1), position sizes (10-10000), bankroll (1000-1000000)
- Test full composition chain: calculateGrossEdge → calculateNetEdge → position sizing → reserveBudget
- AC: 1000+ random inputs, every output finite Decimal, no NaN/Infinity/negative position sizes

**Story 4.5.2: Pipeline Latency Instrumentation**
- Add Date.now() timing to detection → risk validation → execution lock → budget reservation in executeCycle()
- AC: Each pipeline stage logs duration in ms, total cycle time logged, baseline from 100+ test cycles

**Story 4.5.3: Shared e2e Test Environment Config**
- Extract shared test environment object imported by all e2e specs
- AC: Single source of truth for test env vars, all e2e tests pass, new env vars require 1 file change

**Story 4.5.4: Technical Debt Consolidation**
- Create `technical-debt.md` and `docs/gotchas.md` from Epics 2-4 dev notes
- Include: plainToInstance defaults, OnModuleInit ordering, ConfigService.get returning strings, circular import resolution, fire-once event pattern
- AC: Both files exist, all known debt cataloged with priority/target, gotchas have code examples

## Post-Epic 5 Gates

### Error Code Catalog Reconciliation
- Trigger: After Epic 5 ships (2000-2999 execution error codes assigned)
- Scope: Update PRD error catalog to match codebase as single source of truth
- Owner: Arbi

### Live Market Dry-Run Validation
- Trigger: After Epic 5 built, before production deployment
- Scope: 48 hours read-only detection against live market data, manually verify 20-30 opportunities
- Rationale: Epic 5's integration testing against Kalshi sandbox and Polymarket testnet provides the natural dry-run phase. This gate ensures live market accuracy before real money flows.
- Owner: Arbi

## Readiness Assessment

| Area | Status |
|---|---|
| Testing & Quality | ✅ 484 unit tests, 11 code review fixes. Property-based validation in Epic 4.5 |
| Deployment | ⏸️ Local only — production deployment post-Epic 5 |
| Stakeholder Acceptance | ✅ N/A — single operator project |
| Technical Health | ✅ Stable and maintainable |
| Unresolved Blockers | ✅ None blocking. Validation gaps addressed by Epic 4.5 |

## Action Items Summary

| # | Action Item | Owner | Type | Mechanism |
|---|---|---|---|---|
| 1 | No floating retro commitments — all prep work becomes stories | Bob + Arbi | Process | Enforced by converting to stories with ACs |
| 2 | Epic 4.5 — Pre-Execution Validation Sprint | Arbi | Hard gate | 5 stories, must complete before Epic 5 |
| 3 | Error code catalog reconciliation | Arbi | Deferred | Trigger: post-Epic 5 |
| 4 | Live market dry-run validation gate | Arbi | Deferred | Trigger: pre-production deployment |

## Retrospective Commitments

### What We Learned
- Retro commitments outside the story system don't execute — three-epic proof
- "Ready to build" vs "ready to run" is a critical distinction for financial systems
- First-of-a-kind stories pay tax that compounds into velocity for all subsequent work
- Code reviews remain the last line of defense against production bugs
- Story-to-story handoff documentation is a genuine velocity multiplier

### What We'll Do Differently
- **All prep work becomes stories with ACs** — no more floating retro action items
- **Epic 4.5 as hard gate before Epic 5** — validation sprint with real acceptance criteria
- **Dry-run validation folded into Epic 5's integration testing phase** — not a separate blocked infrastructure project
- **Error code reconciliation deferred to natural checkpoint** — after Epic 5 when all codes are assigned

### What We'll Keep Doing
- Code review on every story with severity-graded fixes
- Rich dev notes with decision rationale and scope guards
- Previous Story Intelligence sections for smooth handoffs
- Architecture compliance (module boundaries, error hierarchy, event patterns)
- Regression gate at every story (test count baseline tracking)
- Sprint 0 / validation sprint pattern for complex transitions

## Team Acknowledgment

Epic 4 delivered a complete risk management and capital protection layer:
- Position sizing (3% bankroll cap) + portfolio limits (10 pairs) + daily loss halt (5%) + operator override with audit trail + sequential execution locking + atomic budget reservation lifecycle + crash recovery
- 103 new tests (381 → 484) with zero regressions
- 11 code review fixes including 2 high-severity production bug catches
- Zero architectural violations across 4 stories
- First REST endpoint with full auth/validation/error-wrapping foundation
- Honest retro identifying and solving a three-epic pattern of unfulfilled commitments

**Performance:** Excellent. 100% delivery, capital protection operational, execution infrastructure ready. Epic 4.5 closes validation gaps before Epic 5.

---

**Retrospective Status:** Complete
**Epic 4 Status:** Delivered
**Epic 4.5 Status:** Planned — hard gate before Epic 5
**Next Milestone:** Epic 4.5 (regression baseline → property-based testing → latency instrumentation → shared e2e config → debt consolidation) → Epic 5
