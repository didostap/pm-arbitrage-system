# Epic 5 Retrospective - Trade Execution, Leg Management & Exit Monitoring

**Date:** 2026-02-21
**Epic:** Epic 5 (Stories 5.1 - 5.5)
**Facilitator:** Bob (Scrum Master)
**Participant:** Arbi (Project Lead / Tech Lead)

## Epic Summary

**Delivery Metrics:**
- **Completed:** 5/5 stories — 100%
- **Test Progression:** 508 → 542 → 572 → 613 → 647 → 731
- **New Tests Added:** 223 across Epic 5 (biggest increase in any epic)
- **Test Files:** 53 total
- **Coverage:** 90.48% statements, 87.78% functions, 90.89% lines (2,439 statements)
- **Code Review Fixes:** 16 total (4 high, 9 medium, 3 low severity) across Stories 5.1-5.4
- **Technical Debt Items:** 5 carry-forward, 0 new structural debt
- **Production Incidents:** 0
- **Import Boundary Violations:** 0
- **New REST API Endpoints:** 4 (retry-leg, close-leg, reconciliation resolve, reconciliation run)

**Stories Delivered:**
1. **Story 5.1: Order Submission & Position Tracking** — Two-leg execution pipeline, depth verification, order/position persistence, `submitOrder()` on both connectors, `IExecutionEngine` interface, `ExecutionError` class. 42 new tests (508→542).
2. **Story 5.2: Single-Leg Exposure Detection & Alerting** — `SingleLegExposureEvent` with P&L scenarios, `ExposureTrackerService` with monthly/weekly thresholds, graceful degradation on order book fetch failure. 30 new tests (542→572).
3. **Story 5.3: Single-Leg Resolution & Operator Actions** — REST endpoints for retry-leg and close-leg, `ExposureAlertScheduler` with 60s re-emission, `closePosition()` on `IRiskManager`, `SingleLegResolvedEvent`. 41 new tests (572→613).
4. **Story 5.4: Exit Monitoring & Fixed Threshold Exits** — `ExitManagementModule`, pure `ThresholdEvaluatorService`, 30s polling cycle, take-profit/stop-loss/time-based thresholds, `EXIT_PARTIAL` status integration. 34 new tests (613→647).
5. **Story 5.5: Startup Reconciliation & Crash Recovery** — `ReconciliationModule`, 4-phase reconciliation flow, halt state refactored from single to `Set<HaltReason>`, `getOrder()` on both connectors, operator resolution endpoints, startup lifecycle integration. 84 new tests (647→731).

**Business Outcomes:**
- Full two-leg execution pipeline operational (Kalshi + Polymarket)
- Single-leg exposure detection, P&L scenario alerting, and manual resolution
- Exit monitoring with take-profit (80% captured edge), stop-loss (2x initial edge), and time-based (48h before resolution) thresholds
- Startup reconciliation with crash recovery, pending order resolution, and operator endpoints
- 4 new REST API endpoints for operator control of exposed and discrepant positions

## Previous Retrospective Follow-Through (Epic 4.5)

| # | Action Item | Status | Evidence |
|---|---|---|---|
| 1 | Embed three DoD gates (test isolation, interface preservation, normalization ownership) into every Epic 5 story | ✅ Done | All 5 stories have explicit DoD Gates sections referencing all 3 gates |
| 2 | Convert all practices to story-level requirements — zero floating commitments | ✅ Done | All prep work from retro was incorporated into story specs |
| 3 | Resolve execution engine placeholder (line 53 TODO) | ✅ Done | Story 5.1 Task 4 replaced TODO with `IExecutionEngine.execute()` |
| 4 | Resolve gas estimation TODO (polymarket.connector.ts:312) | ❌ Not Addressed | Not in any story scope — died as floating commitment |
| 5 | Update technical-debt.md — mark Kalshi dedup resolved, add new items | ⏳ Unknown | Not referenced in any story record |

**Prep Tasks:**

| # | Task | Status |
|---|---|---|
| 1 | e2e fixture spike (Quinn, 3 days) | ⏳ Not explicitly evidenced — all stories mock at unit level |
| 2 | Prisma schema review before 5.1 | ✅ Done | Story 5.1 has detailed schema design section |
| 3 | Story 5.2 spec ready before 5.1 merges | ✅ Done | 5.2 story exists with full spec |

**Summary:** 3/5 action items completed. 2/5 failed — both were floating commitments without stories. Pattern holds for fifth consecutive epic: stories with ACs deliver, floating commitments don't.

**Key Learning:** The failure mode is not ignorance — we know floating commitments fail. The failure mode is the moment between identifying an action item and deciding whether it's worth a story. Items that feel "too small" for a story get written as action items and die. Solution: binary choice — story or explicit drop. No purgatory.

## What Went Well

### 1. Full Execution Pipeline Delivered
- Went from a TODO placeholder in execution queue to complete trading pipeline
- Two-leg submission with depth verification, single-leg detection and resolution, exit monitoring, crash recovery
- System can now execute trades end-to-end — the first time this is true

### 2. Testing Discipline at Scale
- 223 new tests across 5 stories — biggest increase in any epic
- Clean progression: 508 → 542 → 572 → 613 → 647 → 731
- Zero regressions, zero flaky tests
- DoD gates from Epic 4.5 retro enforced in every story

### 3. Code Review Catching Critical Issues
- 16 code review fixes across Stories 5.1-5.4 (4 high, 9 medium, 3 low)
- Story 5.1 H1: Connector decoupling — prevented concrete class injection that would have broken Epic 5.5's decorator pattern
- Story 5.1 H2: Wrong event emission on depth failure — would have silently corrupted monitoring data
- Story 5.1 H3: Added 5 comprehensive Polymarket `submitOrder` tests
- Story 5.2 H1: Added pnlScenarios and recommendedActions to ExecutionError metadata for AC 2 compliance
- Story 5.3 M4: P&L scenario duplication eliminated — scheduler delegates to service
- Story 5.3 L2: N+1 query fixed — `findByStatusWithPair()` added to scheduler
- Story 5.4 M1: Hardcoded zeros in partial exit context replaced with actual values
- Story 5.4 M3: Typed `executeExit` param as `ThresholdEvalResult` instead of unsafe inline cast

### 4. Event Naming Discipline
- Story 5.3: `SINGLE_LEG_EXPOSURE_REMINDER` (not `SINGLE_LEG_EXPOSURE`) for 60s re-emissions
- Prevented subtle bug: single unresolved exposure generating 5 re-emissions/5min would falsely trigger monthly threshold of 5
- Demonstrates team's understanding of event semantics beyond just "emit an event"

### 5. Proactive Architecture Decisions
- Story 5.5: Halt state refactored from single `haltReason` to `Set<HaltReason>` — prevents reconciliation halt from overwriting daily loss halt
- Story 5.5: Reconciliation placed in dedicated `src/reconciliation/` module instead of `persistence/` (ADR documented)
- Story 5.4: Pure `ThresholdEvaluatorService` — zero side effects, trivially replaceable in Phase 1 for model-driven exits

### 6. Architecture Integrity Maintained
- Zero import boundary violations across 5 stories touching every layer
- Module dependencies respected: execution → connectors + risk-management, never reverse
- All cross-module communication through interfaces in `common/interfaces/`
- Hot path (synchronous) and fan-out (async EventEmitter2) patterns consistently applied

## Challenges & Learnings

### 1. Mock Maintenance Burden
- **Challenge:** 3 out of 5 stories required updating 4-6 mock files across the codebase when interfaces changed
- **Impact:** Story 5.5 touched 6 mock files for `getOrder()` alone. Error-prone scavenger hunts. Story specs included explicit "mock update checklists" as a workaround.
- **Root Cause:** Architecture is correct (interface-driven, loose coupling). Test infrastructure hasn't scaled — mocks are duplicated across test files instead of centralized.
- **Resolution:** Story 5.5.0 delivers centralized mock factories: `createMockPlatformConnector()`, `createMockRiskManager()` with overridable defaults. All existing test files migrated.
- **Learning:** Test tooling is a first-class concern. When 3/5 stories need mock update checklists, the mocking strategy needs investment.

### 2. Interface Expansion Pressure
- **Challenge:** 7+ new methods added to `IRiskManager` and `IPlatformConnector` across 5 stories
- **Impact:** `IRiskManager` grew from position sizing + daily loss limits to also include trading halt lifecycle, P&L recalculation, and order queries. Trending toward catch-all.
- **Distinction:** Methods from Stories 5.1-5.3 were planned and necessary (`IExecutionEngine`, `closePosition()`). Story 5.5's 4 methods in a single story (`haltTrading`, `resumeTrading`, `recalculateFromPositions`, `getOrder`) signal catch-all growth.
- **Resolution:** Watched item. If `IRiskManager` gains 2+ new methods in Epic 6, create a split story: `IRiskManager` for pre-trade validation, `ITradingStateManager` for runtime lifecycle.
- **Learning:** Interface growth isn't inherently bad — but the rate and category of growth matters. Pre-trade vs runtime is a meaningful boundary.

### 3. P&L Source-of-Truth Confusion
- **Challenge:** 3 separate stories (5.3, 5.4, 5.5) had to explicitly warn: use fill prices from ORDER records, not `position.entryPrices`
- **Root Cause:** `entryPrices` was accurate when Story 5.1 designed it (both legs fill atomically). Story 5.3 introduced single-leg resolution where retry fills at different prices → `entryPrices` can be stale.
- **Resolution:** (1) Document in gotchas.md: "Always compute P&L from order fill records, never from `position.entryPrices`" with code example. (2) Treat `entryPrices` as informational/denormalized, not canonical. (3) Do NOT add reconciliation step to keep it current — that's complexity to maintain a non-authoritative field.
- **Learning:** Data model fields that are accurate at design time can become misleading as the system evolves. Document the authoritative source clearly, don't try to keep denormalized data in sync.

### 4. Retro Commitment Follow-Through (3/5)
- **Challenge:** Gas estimation TODO and technical-debt.md update died as floating action items
- **Root Cause:** Both felt "too small" for a story, so they were written as action items. Same failure mode as Epic 3 retro items.
- **Resolution:** Binary choice going forward — story with ACs or explicit drop. No middle ground. No purgatory.
- **Learning:** The threshold for "worth a story" should be low. A one-hour story that actually ships is infinitely better than a five-minute commitment that never happens.

## Key Insights

1. **Story-or-drop discipline** — five epics of evidence. Floating commitments fail 100% of the time. Stories with ACs deliver. Binary choice, no middle ground.
2. **Test infrastructure must scale with architecture** — interface-driven design pays compound returns, but centralized mock factories are overdue. Mock duplication is a defect risk, not just a convenience issue.
3. **Interface freeze enables decorator patterns** — wrapping an interface that's still growing creates fragility. Freeze the interface, then build on top.
4. **Prep work belongs in epics, not as separate sprints** — Epic 4.5 proved validation sprints work but shouldn't recur. Story 5.5.0 embeds prep as the first story in the epic.
5. **Compound return on disciplined foundations** — Sprint 0's module boundaries, error hierarchies, and event patterns felt like overhead at the time. Epic 5's zero import violations across five stories touching every layer is the return on that investment.
6. **Existing interfaces are contracts, even informal ones** — established in Epic 4.5, reinforced in Epic 5. Add alongside, don't modify.

## Technical Debt Inventory

### Resolved in Epic 5
1. ~~Execution engine placeholder (execution-queue.service.ts line 53 TODO)~~ → Resolved by Story 5.1

### Carry-Forward

| # | Item | Priority | Target | Source |
|---|---|---|---|---|
| 1 | Gas estimation TODO (`polymarket.connector.ts`) | Medium | Epic 6 (story) | Epic 2, carried through 4.5 |
| 2 | `cancelOrder()` not implemented on either connector | High | Story 5.5.0 | Epic 5 |
| 3 | `resolutionDate` has no write path — time-based exits non-functional | Low | Epic 9/10 (deferred) | Story 5.4 |
| 4 | `entryPrices` on positions can be stale after single-leg resolution | Low | Document only (gotchas.md) | Story 5.3 |
| 5 | `force_close` in reconciliation doesn't capture real P&L | Low | Epic 6/12 compliance tooling | Story 5.5 |
| 6 | Error code catalog reconciliation — PRD vs codebase | Low | Post-Epic 6 | Epic 4 |
| 7 | Polymarket order book minor duplication | Low | Monitor | Epic 4.5 |
| 8 | `forwardRef` for ConnectorModule ↔ DataIngestionModule | Low | Monitor | Epic 4.5 |
| 9 | Architecture doc: reconciliation module in `src/reconciliation/` not `persistence/` | Medium | Story 5.5.0 | Story 5.5 |

### Deferred Gates (unchanged)
- **Live market dry-run validation** — 48h read-only detection gate before production deployment
- **Error code catalog reconciliation** — after Epic 6 ships

## Coverage Concerns (Flagged for Story 5.5.0 Audit)

| Area | Statement Coverage | Branch Coverage | Concern |
|---|---|---|---|
| `src/persistence/repositories` | 52.17% | 0% | Data access layer in financial system. Conditional logic untested. Story 5.5.2 adds `is_paper` filtering here. |
| `src/connectors/kalshi` | 71.72% | 63.93% | 78/122 branches uncovered. Error handling paths, timeout scenarios. `cancelOrder()` in 5.5.0 will exercise some. |
| `src/core` | 80.89% | 61.53% | 32/52 branches uncovered. Trading engine orchestration decision paths. |
| `src/modules/risk-management` | 98.35% | — | Excellent. Exactly where you want high coverage. |
| `src/modules/contract-matching` | 100% | — | Excellent. |
| `src/modules/arbitrage-detection` | 99.1% | — | Excellent. |

**Action:** Story 5.5.0 includes persistence coverage audit subtask. Identify untested business logic vs Prisma pass-through. Flag specific gaps for coverage in stories that touch those files.

## Action Items — Stories (Committed to Backlog)

| # | Story | Epic | Success Criteria |
|---|---|---|---|
| 1 | **Story 5.5.0: Interface Stabilization & Test Infrastructure** | 5.5 | `cancelOrder()` functional on both connectors; mock factories centralized with `createMock*()` exports; all existing test files migrated to factories; gotchas.md updated with P&L source-of-truth rule and code example; technical-debt.md updated (Kalshi dedup resolved, Epic 5 items added, gas estimation story ref); architecture doc updated (reconciliation module location); persistence coverage audit completed and gaps documented |
| 2 | **Gas estimation implementation** | 6 (early) | Gas cost included in edge calculations, TODO in `polymarket.connector.ts` removed, informed by paper trading data |

## Action Items — Process Changes (Embedded in Workflow)

| # | Change | Enforcement |
|---|---|---|
| 1 | **Story-or-drop discipline** — every retro item is a story with ACs or explicitly dropped. No action item purgatory. | Bob enforces during retro. If not worth a story, say "choosing not to do this" out loud. |
| 2 | **Story template: "Check gotchas.md" reminder** | Added to story template by Bob before Epic 5.5 |
| 3 | **Interface freeze for Epic 5.5** — `IPlatformConnector` and `IRiskManager` frozen after Story 5.5.0. Exceptions: team discussion + full ripple handling in one PR (mock factory + decorator updated together). Goal is preventing casual additions, not rigidity. | Team agreement. Violations flagged in code review. |

## Watched Items (Trigger Conditions Defined)

| # | Item | Trigger for Story Creation |
|---|---|---|
| 1 | `IRiskManager` interface bloat (pre-trade validation vs runtime lifecycle) | 2+ new methods added in Epic 6 |
| 2 | `entryPrices` field reliability | Someone computes P&L from it incorrectly despite gotcha documentation |
| 3 | Time-based exits (`resolutionDate` write path) | Advanced exit logic in Epic 9/10, or operator requests sooner |

## Explicitly Dropped (Conscious Decisions)

| # | Item | Rationale |
|---|---|---|
| 1 | Reconciliation step to keep `entryPrices` current | Adds complexity to maintain a non-authoritative field. Document as informational instead. |
| 2 | Separate validation sprint before Epic 5.5 | One-time correction pattern (Epic 4.5), not recurring. Prep embedded as Story 5.5.0. |

## Team Agreements

1. **Interface freeze** — `IPlatformConnector` and `IRiskManager` frozen after Story 5.5.0 ships. No new methods until Epic 6 unless team discusses and handles full ripple (mock factory + decorator) in the same PR.
2. **Story-or-drop** — no retro action items without stories. Binary choice made in the retro session itself.
3. **Gotchas.md consultation** — dev agent checks gotchas.md before beginning implementation on any story.

## Readiness Assessment

| Area | Status | Notes |
|---|---|---|
| Testing & Quality | ✅ | 731 tests, 90.48% statement coverage. Persistence repo gaps flagged for audit. |
| Deployment | ⏸️ | Local only — production deployment post-Epic 6 (by design) |
| Stakeholder Acceptance | ✅ | N/A — single operator project |
| Technical Health | ✅ | Stable and maintainable. No fragility concerns. |
| Unresolved Blockers | ✅ | None. All carry-forward items have stories, watch triggers, or explicit drop decisions. |

## Epic 5.5 Preparation

### Story 5.5.0: Interface Stabilization & Test Infrastructure (first story in epic)

**Deliverables (sequenced):**
1. `cancelOrder()` implementation on Kalshi + Polymarket connectors (stabilizes interface shape)
2. Centralized mock factories for `IPlatformConnector` and `IRiskManager` (built against final interface)
3. Migration of all existing test files to use mock factories (single source of truth)
4. Gotchas.md: P&L source-of-truth rule with code example
5. Technical-debt.md: mark Kalshi dedup resolved, add Epic 5 items, gas estimation story reference
6. Architecture doc: reconciliation module location update
7. Persistence repository coverage audit — document untested business logic vs Prisma pass-through

**Dependency chain:** `cancelOrder()` → mock factory (needs final interface) → decorator in Story 5.5.1 (wraps stable interface)

**Interface freeze takes effect after this story merges.**

### Sequencing
- Story 5.5.0 → Story 5.5.1 (PaperTradingConnector decorator, depends on stable interface + mock factory)
- Story 5.5.2 spec review can happen during 5.5.0 development
- Story 5.5.3 spec review can happen during 5.5.1 development

## Retrospective Commitments Summary

### What We Learned
- Story-or-drop discipline — five-epic proof. No middle ground on commitments.
- Test infrastructure is a first-class concern that must scale with architecture.
- Interface freeze enables decorator patterns. Stable foundations before building on top.
- Compound return on disciplined foundations — Sprint 0's investment pays dividends in every epic.
- Prep work embedded in epics (Story X.0 pattern) is better than separate validation sprints.

### What We'll Do Differently
- **Binary choice on every retro item** — story or explicit drop, decided in the retro session
- **Centralized mock factories** — no more duplicated mocks across test files
- **Interface freeze commitment** — no casual method additions during decorator-dependent epics
- **Gotchas.md in story template** — devs check it before starting implementation
- **Coverage-informed testing** — audit gaps, address in stories that touch those files

### What We'll Keep Doing
- Code review on every story with severity-graded fixes
- DoD gates: test isolation, interface preservation, normalization ownership
- Story-to-story handoff documentation
- Scope discipline via "What NOT to Do" / "Out of Scope" sections
- Architecture compliance (module boundaries, error hierarchy, event patterns)
- Regression gate (test count baseline tracking per story)
- Converting all commitments to stories with ACs

## Team Acknowledgment

Epic 5 delivered the complete execution layer — the system's ability to actually trade:
- Two-leg order submission with depth verification and configurable primary leg
- Single-leg exposure detection with P&L scenarios, operator alerting, and manual resolution
- Exit monitoring with three threshold types (take-profit, stop-loss, time-based)
- Startup reconciliation with crash recovery, pending order resolution, and trading halt management
- 223 new tests (508 → 731) with zero regressions — biggest testing increase in any epic
- 16 code review fixes (4 high, 9 medium, 3 low) — high-severity catches prevented production defects
- Zero architectural violations across 5 stories touching every layer of the system
- First REST API endpoints for operator control (retry-leg, close-leg, reconciliation)

**Performance:** Excellent. 100% delivery, architecture integrity maintained, compound returns on disciplined foundations realized. The system is ready for paper trading validation.

---

**Retrospective Status:** Complete
**Epic 5 Status:** Delivered
**Next Milestone:** Story 5.5.0 (Interface Stabilization & Test Infrastructure) → Epic 5.5: Paper Trading Infrastructure
